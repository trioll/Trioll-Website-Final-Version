<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="gameTitle">Loading Game... - Trioll</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/game-player.css">
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>
    <style>
        /* Game Action Buttons */
        .game-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 16px;
            min-width: 120px;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .action-btn .icon {
            font-size: 20px;
        }
        
        .action-btn.liked {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        
        /* Fix comment form spinner */
        .loading-spinner {
            display: none !important;
        }
        
        .btn.loading .button-text {
            display: none;
        }
        
        .btn.loading .loading-spinner {
            display: inline-block !important;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }
        
        /* Ensure button doesn't show loading by default */
        #commentSubmitBtn {
            position: relative;
        }
        
        #commentSubmitBtn.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Rating stars in modal */
        .rating-stars {
            display: flex;
            gap: 10px;
            font-size: 36px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .star {
            cursor: pointer;
            transition: transform 0.2s;
            opacity: 0.3;
        }
        
        .star:hover,
        .star.filled {
            opacity: 1;
            transform: scale(1.2);
        }
        
        /* Fix for game action buttons */
        .game-actions {
            position: relative !important;
            z-index: 100 !important;
            pointer-events: auto !important;
            display: flex !important;
            justify-content: center !important;
            gap: 16px !important;
            padding: 16px !important;
            background: rgba(26, 26, 26, 0.9) !important;
        }
        
        .game-actions .action-btn {
            cursor: pointer !important;
            pointer-events: auto !important;
            position: relative !important;
            z-index: 101 !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            padding: 8px 16px !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            transition: all 0.2s !important;
            font-size: 14px !important;
            min-width: 80px !important;
            justify-content: center !important;
        }
        
        .game-actions .action-btn:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-2px) !important;
        }
        
        /* Ensure game container doesn't overlap buttons */
        #gameContainer {
            position: relative;
            z-index: 1;
        }
        
        /* Ensure iframe doesn't block interactions */
        #gameIframe {
            pointer-events: auto;
        }
        
        /* Debug - add visual feedback */
        .action-btn:active {
            transform: scale(0.95) !important;
            background: rgba(255, 255, 255, 0.3) !important;
        }
        
        /* Modal Styles */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .modal.hidden {
            display: none;
        }
        
        .modal-content {
            background-color: #1a1a1a;
            margin: 15% auto;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 90%;
            max-width: 400px;
            border-radius: 16px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 15px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close:hover,
        .close:focus {
            color: #fff;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #fff;
        }
        
        #submitRating {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="https://raw.githubusercontent.com/trioll/Trioll/78458b29ad3b63aae3eff39aae462c0ad4cc4d8b/Logo/Trioll_Logo_White.png" alt="Trioll" height="40">
            </a>
            <div class="nav-right">
                <a href="games.html" class="nav-link">Games</a>
                <a href="profile.html" class="nav-link">Profile</a>
                <a href="inventory.html" class="nav-link">Inventory</a>
                <a href="achievements.html" class="nav-link">Achievements</a>
                <span class="guest-indicator hidden"></span>
                <button id="authBtn" class="auth-button">Login</button>
                <div id="userMenu" class="user-menu hidden">
                    <span id="username"></span>
                    <button id="logoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Game Header -->
    <div class="game-header">
        <button class="back-to-games" onclick="handleBackToGames()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 2px;">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Back to Games
        </button>
        <h1 id="gameNameHeader">Loading...</h1>
    </div>

    <!-- Pre-game Ad Slot -->
    <div id="preGameAd" class="ad-container">
        <!-- Future ad integration -->
    </div>

    <!-- Game Container -->
    <div id="gameContainer" class="game-container">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading-screen">
            <div class="loader"></div>
            <p>Loading game...</p>
            <p id="loadingTip" class="loading-tip"></p>
            <div class="loading-progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </div>
        
        <!-- Compatibility Error -->
        <div id="compatError" class="compat-error hidden">
            <h2>Game Not Compatible</h2>
            <p id="compatMessage"></p>
            <div id="compatIssues"></div>
            <a href="index.html" class="btn">Browse Other Games</a>
        </div>
        
        <!-- Game Wrapper -->
        <div id="gameWrapper" class="game-wrapper hidden">
            <!-- Dynamic content based on game engine -->
        </div>
    </div>

    <!-- Game Actions -->
    <div class="game-actions">
        <button id="likeBtn" class="action-btn">
            <span class="icon">‚ù§Ô∏è</span>
            <span id="likeCount">0</span>
        </button>
        <button id="rateBtn" class="action-btn">
            <span class="icon">‚≠ê</span>
            <span>Rate</span>
        </button>
        <button id="shareBtn" class="action-btn">
            <span class="icon">üîó</span>
            <span>Share</span>
        </button>
        <button id="fullscreenBtn" class="action-btn">
            <span class="icon">‚õ∂</span>
            <span>Fullscreen</span>
        </button>
    </div>

    <!-- Comments Section -->
    <section class="comments-section" id="comments">
        <div class="container">
            <h2>Comments</h2>
            
            <!-- Add Comment Form -->
            <div id="addCommentForm" class="comment-form">
                <h3>Leave a Comment</h3>
                <textarea id="commentText" placeholder="Share your thoughts about this game..." rows="4"></textarea>
                <button id="commentSubmitBtn" class="btn btn-primary" onclick="postComment()">
                    <span class="button-text">Post Comment</span>
                    <span class="loading-spinner" style="display: none;"></span>
                </button>
                <p class="comment-notice">Please login to comment</p>
            </div>
            
            <!-- Comments List -->
            <div id="commentsList" class="comments-list">
                <div class="loading-comments">
                    <div class="spinner"></div>
                    <p>Loading comments...</p>
                </div>
            </div>
            
            <!-- Load More Button -->
            <div id="loadMoreContainer" class="load-more-container hidden">
                <button class="btn btn-secondary" onclick="loadMoreComments()">Load More Comments</button>
            </div>
        </div>
    </section>

    <!-- Purchase Intent Modal -->
    <div id="purchaseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="closePurchaseModal()">&times;</span>
            <h2>Enjoyed <span id="purchaseGameName">the game</span>?</h2>
            <p>Would you like to buy the full version?</p>
            <div class="purchase-buttons">
                <button class="btn btn-primary" onclick="trackPurchaseIntent('yes')">Yes, I'm Interested!</button>
                <button class="btn btn-secondary" onclick="trackPurchaseIntent('no')">No Thanks</button>
                <button class="btn btn-tertiary" onclick="trackPurchaseIntent('askLater')">Ask Me Later</button>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="closeRatingModal()">&times;</span>
            <h2>Rate This Game</h2>
            <div class="rating-stars">
                <span class="star" data-rating="1">‚≠ê</span>
                <span class="star" data-rating="2">‚≠ê</span>
                <span class="star" data-rating="3">‚≠ê</span>
                <span class="star" data-rating="4">‚≠ê</span>
                <span class="star" data-rating="5">‚≠ê</span>
            </div>
            <button id="submitRating" class="btn btn-primary">Submit Rating</button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/logger.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cognito-auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/init.js"></script>
    <script src="js/gameLoader.js"></script>
    <script src="js/compatibility.js"></script>
    <script src="js/game-interactions.js"></script>
    <script>
        // Emergency fallback - if no game loads after 5 seconds, force it
        setTimeout(() => {
            const gameWrapper = document.getElementById('gameWrapper');
            const hasIframe = gameWrapper && gameWrapper.querySelector('iframe');
            
            if (!hasIframe) {
                Logger.log('üö® EMERGENCY: No game loaded after 5 seconds, forcing load');
                
                const urlParams = new URLSearchParams(window.location.search);
                const gameId = urlParams.get('id');
                
                if (gameId && gameWrapper) {
                    // Hide everything else
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) {
                        loadingScreen.style.display = 'none';
                    }
                    
                    // Show game wrapper  
                    gameWrapper.style.display = 'block';
                    gameWrapper.classList.remove('hidden');
                    // Emergency loader disabled - main loader handles all cases now
                    Logger.log('‚è≠Ô∏è Emergency loader skipped - main loader has proper fallback');
                    // The main loader with API fallback should handle this
                    // If we reach here, something is seriously wrong
                    const errorMsg = document.createElement('div');
                    errorMsg.style.padding = '20px';
                    errorMsg.style.textAlign = 'center';
                    errorMsg.innerHTML = `
                        <h3>Game Loading Issue</h3>
                        <p>The game is taking longer than expected to load.</p>
                        <p>Please refresh the page or try again later.</p>
                        <button onclick="window.location.reload()">Refresh Page</button>
                    `;
                    gameWrapper.appendChild(errorMsg);
                    
                    const gameName = gameId.replace(/-/g, ' ');
                    document.title = gameName + ' - Trioll';
                    
                    const header = document.getElementById('gameNameHeader');
                    if (header) {
                        header.textContent = gameName;
                    }
                    
                    // Set currentGame for the purchase intent popup
                    window.currentGame = {
                        id: gameId,
                        name: gameName
                    };
                    
                    // Track game start time
                    window.gameStartTime = Date.now();
                    
                    Logger.log('‚úÖ Emergency game load complete');
                }
            }
        }, 5000);
    </script>
    <script>
        // Make currentGame globally accessible
        window.currentGame = window.currentGame || null;
        let currentGame = window.currentGame;
        let currentRating = 0;
        let isLiked = false;
        let comments = [];
        let commentsPage = 1;
        let hasMoreComments = true;
        
        // Debug function to test button functionality
        window.testButtons = function() {
            console.log('üîç Testing button functionality...');
            console.log('Current game:', window.currentGame);
            console.log('Auth status:', { 
                isAuthenticated: Auth?.isAuthenticated(), 
                isGuest: Auth?.isGuest,
                guestId: Auth?.getGuestId()
            });
            console.log('API available:', typeof API !== 'undefined');
            console.log('Analytics available:', typeof Analytics !== 'undefined');
            
            // Try to manually trigger a like
            if (window.currentGame) {
                console.log('Attempting manual like for game:', window.currentGame.id);
            }
        };
        
        // Function to sync local likes to backend
        async function syncLocalLikes() {
            const localLikes = JSON.parse(localStorage.getItem('trioll_liked_games') || '{}');
            const gameIds = Object.keys(localLikes);
            
            if (gameIds.length === 0) return;
            
            Logger.log('Syncing local likes to backend:', gameIds.length, 'games');
            
            let syncedCount = 0;
            for (const gameId of gameIds) {
                try {
                    await API.likeGame(gameId);
                    syncedCount++;
                    // Remove from local storage after successful sync
                    delete localLikes[gameId];
                } catch (error) {
                    Logger.warn('Failed to sync like for game:', gameId);
                }
            }
            
            // Update local storage with remaining unsynced likes
            if (Object.keys(localLikes).length > 0) {
                localStorage.setItem('trioll_liked_games', JSON.stringify(localLikes));
            } else {
                localStorage.removeItem('trioll_liked_games');
            }
            
            if (syncedCount > 0) {
                Logger.log(`Successfully synced ${syncedCount} likes to backend`);
            }
        }
        
        // Function to sync local ratings to backend
        async function syncLocalRatings() {
            const localRatings = JSON.parse(localStorage.getItem('trioll_game_ratings') || '{}');
            const gameIds = Object.keys(localRatings);
            
            if (gameIds.length === 0) return;
            
            Logger.log('Syncing local ratings to backend:', gameIds.length, 'games');
            
            let syncedCount = 0;
            for (const gameId of gameIds) {
                try {
                    await API.rateGame(gameId, localRatings[gameId]);
                    syncedCount++;
                    // Remove from local storage after successful sync
                    delete localRatings[gameId];
                } catch (error) {
                    Logger.warn('Failed to sync rating for game:', gameId);
                }
            }
            
            // Update local storage with remaining unsynced ratings
            if (Object.keys(localRatings).length > 0) {
                localStorage.setItem('trioll_game_ratings', JSON.stringify(localRatings));
            } else {
                localStorage.removeItem('trioll_game_ratings');
            }
            
            if (syncedCount > 0) {
                Logger.log(`Successfully synced ${syncedCount} ratings to backend`);
            }
        }
        
        // Debug: Check if elements exist
        Logger.log('üîç Initial page check:', {
            loadingScreen: document.getElementById('loadingScreen'),
            gameWrapper: document.getElementById('gameWrapper'),
            compatError: document.getElementById('compatError')
        });
        
        // Get game ID from URL and load
        window.addEventListener('trioll-initialized', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');
            
            if (!gameId) {
                window.location.href = 'games.html';
                return;
            }
            
            
            // Redirect to login if no session (neither authenticated nor guest)
            if (!Auth.isAuthenticated() && !Auth.isGuest) {
                window.location.href = 'login.html';
                return;
            }
            
            // Try to sync local data if authenticated
            if (Auth.isAuthenticated()) {
                syncLocalLikes().catch(err => Logger.warn('Failed to sync likes:', err));
                syncLocalRatings().catch(err => Logger.warn('Failed to sync ratings:', err));
            }
            
            try {
                // Load game details
                currentGame = await API.getGame(gameId);
                window.currentGame = currentGame; // Make it globally accessible
                
                // Update page title and header
                document.title = `${currentGame.name} - Play on Trioll`;
                document.getElementById('gameNameHeader').textContent = currentGame.name;
                
                // Update stats
                document.getElementById('likeCount').textContent = currentGame.likeCount || 0;
                
                // Check if user has liked - check local storage
                const likedGames = JSON.parse(localStorage.getItem('trioll_liked_games') || '{}');
                isLiked = likedGames[gameId] || false;
                updateLikeButton();
                
                // Load the game directly - simplified approach
                Logger.log('üéÆ Loading game:', gameId);
                Logger.log('üéÆ Current game data:', currentGame);
                
                // Hide loading screen and show game wrapper
                const loadingScreen = document.getElementById('loadingScreen');
                const gameWrapper = document.getElementById('gameWrapper');
                
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                    loadingScreen.classList.add('hidden');
                }
                
                if (gameWrapper) {
                    gameWrapper.style.display = 'block';
                    gameWrapper.classList.remove('hidden');
                    
                    // Create iframe directly (like working-game.html)
                    // Use game URL if provided, otherwise construct from CDN
                    let gameUrl = currentGame.gameUrl || currentGame.trialUrl;
                    if (!gameUrl) {
                        const gameId = currentGame.id || currentGame.gameId;
                        // Try new CDN first, fallback to legacy
                        gameUrl = `${Config.GAME_CDN_URL}/${gameId}/index.html`;
                    }
                    
                    Logger.log('üéÆ Creating iframe with URL:', gameUrl);
                    
                    const iframe = document.createElement('iframe');
                    iframe.id = 'gameIframe'; // Add ID for button interactions
                    iframe.src = gameUrl;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    iframe.setAttribute('allowfullscreen', '');
                    iframe.setAttribute('allow', 'accelerometer; gyroscope; autoplay');
                    
                    // Clear any existing content
                    gameWrapper.innerHTML = '';
                    gameWrapper.appendChild(iframe);
                    
                    // Log when iframe loads
                    iframe.onload = () => {
                        Logger.log('‚úÖ Game iframe loaded successfully');
                        // Track when game actually starts playing
                        window.gameStartTime = Date.now();
                    };
                    
                    iframe.onerror = (error) => {
                        Logger.error('‚ùå Game iframe failed to load:', error);
                        // Try legacy CDN as fallback
                        if (gameUrl.includes(Config.GAME_CDN_URL)) {
                            Logger.log('Trying legacy CDN...');
                            const gameId = currentGame.id || currentGame.gameId;
                            iframe.src = `${Config.LEGACY_CDN_URL}/${gameId}/index.html`;
                        }
                    };
                }
                
                // Track game play
                await API.trackPlay(gameId);
                API.trackLocalActivity('play', gameId, { gameName: currentGame.name });
                
                // Track analytics with device information
                Analytics.track('game_play', {
                    gameId: gameId,
                    gameName: currentGame.name,
                    source: 'web',
                    platform: 'pc',
                    device: Analytics.getDeviceType(),
                    referrer: document.referrer,
                    directLink: !document.referrer.includes('trioll.com'),
                    browser: Analytics.getBrowser(),
                    os: Analytics.getOS(),
                    screenResolution: `${window.screen.width}x${window.screen.height}`
                });
                
                // Update play count
                const currentPlays = parseInt(localStorage.getItem('trioll_games_played') || '0');
                localStorage.setItem('trioll_games_played', (currentPlays + 1).toString());
                
                // Add to recent games
                const recentGames = JSON.parse(localStorage.getItem('trioll_recent_games') || '[]');
                const gameData = {
                    id: currentGame.id || currentGame.gameId,
                    gameId: currentGame.id || currentGame.gameId,
                    name: currentGame.name,
                    developerName: currentGame.developerName,
                    thumbnailUrl: currentGame.thumbnailUrl,
                    playedAt: Date.now()
                };
                
                // Remove if already in recent (to avoid duplicates)
                const filtered = recentGames.filter(g => g.id !== gameData.id);
                filtered.push(gameData);
                
                // Keep only last 50 recent games
                if (filtered.length > 50) {
                    filtered.splice(0, filtered.length - 50);
                }
                
                localStorage.setItem('trioll_recent_games', JSON.stringify(filtered));
                
                // Setup action buttons
                setupActionButtons();
                
                // Setup auth button
                document.getElementById('authBtn').addEventListener('click', () => {
                    if (Auth.isGuest) {
                        localStorage.removeItem('trioll_guest_active');
                        window.location.href = 'login.html';
                    } else {
                        window.location.href = 'login.html';
                    }
                });
                
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    Auth.signOut();
                    window.location.href = 'login.html';
                });
                
                // Load comments
                await loadComments();
                
                // Setup comment form
                setupCommentForm();
                
                // Purchase intent will show when user navigates back
                // setTimeout(showPurchaseModal, 120000);
                
            } catch (error) {
                Logger.error('Failed to load game details from /games/{id}:', error);
                
                // Try fetching from games list as fallback
                try {
                    Logger.log('üìã Attempting to fetch game from /games list...');
                    const listResponse = await fetch(`${Config.API_BASE_URL}/games?limit=100`);
                    
                    if (listResponse.ok) {
                        const data = await listResponse.json();
                        const gameFromList = data.games.find(g => g.id === gameId);
                        
                        if (gameFromList) {
                            Logger.log('‚úÖ Found game in list:', gameFromList);
                            currentGame = gameFromList;
                            window.currentGame = currentGame;
                            
                            // Update page info
                            document.title = `${currentGame.title || currentGame.name} - Play on Trioll`;
                            document.getElementById('gameNameHeader').textContent = currentGame.title || currentGame.name;
                            document.getElementById('likeCount').textContent = currentGame.likeCount || 0;
                            
                            // Load the game
                            const loadingScreen = document.getElementById('loadingScreen');
                            const gameWrapper = document.getElementById('gameWrapper');
                            
                            if (loadingScreen) {
                                loadingScreen.style.display = 'none';
                                loadingScreen.classList.add('hidden');
                            }
                            
                            if (gameWrapper) {
                                gameWrapper.style.display = 'block';
                                gameWrapper.classList.remove('hidden');
                                
                                // Use the exact URL from the API
                                const gameUrl = currentGame.gameUrl || currentGame.trialUrl;
                                Logger.log('üéÆ Loading game from URL:', gameUrl);
                                
                                const iframe = document.createElement('iframe');
                                iframe.id = 'gameIframe';
                                iframe.src = gameUrl;
                                iframe.style.width = '100%';
                                iframe.style.height = '100%';
                                iframe.style.border = 'none';
                                iframe.setAttribute('allowfullscreen', '');
                                iframe.setAttribute('allow', 'accelerometer; gyroscope; autoplay');
                                
                                iframe.onload = () => {
                                    Logger.log('‚úÖ Game loaded successfully');
                                    window.gameStartTime = Date.now();
                                };
                                
                                iframe.onerror = () => {
                                    Logger.error('‚ùå Failed to load game from URL:', gameUrl);
                                    showError('Failed to load game. The game may not be available.');
                                };
                                
                                gameWrapper.innerHTML = '';
                                gameWrapper.appendChild(iframe);
                            }
                            
                            return; // Success, exit early
                        }
                    }
                } catch (listError) {
                    Logger.error('Failed to fetch from games list:', listError);
                }
                
                // If we get here, both API calls failed
                showError('Failed to load game. Please try again later.');
            }
        });
        
        function setupActionButtons() {
            // Debug - log button setup
            console.log('üéÆ Setting up action buttons...');
            
            // Like button
            const likeBtn = document.getElementById('likeBtn');
            if (!likeBtn) {
                Logger.error('Like button not found!');
                console.error('‚ùå Like button element not found in DOM');
                return;
            }
            
            // Check if button is already setup (avoid duplicate listeners)
            if (likeBtn.hasAttribute('data-listener-attached')) {
                console.log('‚ö†Ô∏è Like button already has listener attached, skipping');
                return;
            }
            
            Logger.log('Setting up like button for game:', currentGame?.id);
            console.log('‚úÖ Like button found, attaching listener');
            
            likeBtn.setAttribute('data-listener-attached', 'true');
            
            likeBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Re-check currentGame from window
                currentGame = window.currentGame;
                
                Logger.log('Like button clicked! Current state:', { isLiked, likeCount: currentGame?.likeCount });
                console.log('‚ù§Ô∏è LIKE BUTTON CLICKED!', { 
                    isLiked, 
                    gameId: currentGame?.id, 
                    currentGame, 
                    windowCurrentGame: window.currentGame,
                    event: e 
                });
                
                if (!currentGame || !currentGame.id) {
                    console.error('‚ùå Game not loaded:', { currentGame, window: window.currentGame });
                    alert('Game not loaded yet. Please wait a moment and try again.');
                    return;
                }
                
                // Allow guests to like on web platform
                // if (Auth.isGuest) {
                //     alert('Please login to like games');
                //     return;
                // }
                
                try {
                    // Toggle like state immediately for instant feedback
                    isLiked = !isLiked;
                    currentGame.likeCount = isLiked ? (currentGame.likeCount || 0) + 1 : Math.max(0, (currentGame.likeCount || 0) - 1);
                    
                    // Update UI immediately
                    updateLikeButton();
                    console.log('‚ù§Ô∏è Like state updated:', { isLiked, newCount: currentGame.likeCount });
                    
                    // Try API call in background (don't wait)
                    if (isLiked) {
                        API.likeGame(currentGame.id).catch(err => 
                            Logger.warn('API like failed (will use local storage):', err)
                        );
                    } else {
                        API.unlikeGame(currentGame.id).catch(err => 
                            Logger.warn('API unlike failed (will use local storage):', err)
                        );
                    }
                    
                    // Store likes locally for persistence
                    const likedGames = JSON.parse(localStorage.getItem('trioll_liked_games') || '{}');
                    if (isLiked) {
                        likedGames[currentGame.id] = true;
                    } else {
                        delete likedGames[currentGame.id];
                    }
                    localStorage.setItem('trioll_liked_games', JSON.stringify(likedGames));
                    
                    updateLikeButton();
                    
                    // ALWAYS track analytics, even for guests
                    const analyticsData = {
                        gameId: currentGame.id,
                        gameName: currentGame.name,
                        action: isLiked ? 'like' : 'unlike',
                        source: 'web',
                        platform: 'pc',
                        device: Analytics.getDeviceType(),
                        isGuest: Auth.isGuest || false,
                        userId: Auth.getCurrentUserId() || Auth.getGuestId() || 'anonymous',
                        localStorage: true, // Flag that this was stored locally
                        timestamp: Date.now()
                    };
                    
                    // Track the like event
                    Analytics.track('game_like', analyticsData);
                    
                    // Also track a specific guest interaction event if guest
                    if (Auth.isGuest) {
                        Analytics.track('guest_game_interaction', {
                            ...analyticsData,
                            interactionType: 'like'
                        });
                    }
                } catch (error) {
                    Logger.error('Failed to update like:', error);
                    // Don't show alert - we handled it gracefully with local storage
                }
            });
            
            // Rate button
            const rateBtn = document.getElementById('rateBtn');
            if (rateBtn && !rateBtn.hasAttribute('data-listener-attached')) {
                console.log('‚úÖ Rate button found, attaching listener');
                rateBtn.setAttribute('data-listener-attached', 'true');
                rateBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('‚≠ê RATE BUTTON CLICKED!');
                    
                    // Re-check currentGame from window
                    currentGame = window.currentGame;
                    
                    if (!currentGame || !currentGame.id) {
                        console.error('‚ùå Game not loaded for rating:', { currentGame, window: window.currentGame });
                        alert('Game not loaded yet. Please wait a moment and try again.');
                        return;
                    }
                    
                    console.log('üìä Opening rating modal for game:', currentGame);
                    document.getElementById('ratingModal').classList.remove('hidden');
                });
            }
            
            // Share button
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn && !shareBtn.hasAttribute('data-listener-attached')) {
                console.log('‚úÖ Share button found, attaching listener');
                shareBtn.setAttribute('data-listener-attached', 'true');
                shareBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîó SHARE BUTTON CLICKED!');
                    
                    // Re-check currentGame from window
                    currentGame = window.currentGame;
                    
                    if (!currentGame || !currentGame.id) {
                        console.error('‚ùå Game not loaded for sharing:', { currentGame, window: window.currentGame });
                        alert('Game not loaded yet. Please wait a moment and try again.');
                        return;
                    }
                    
                const url = window.location.href;
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: currentGame.name,
                            text: `Check out ${currentGame.name} on Trioll!`,
                            url: url
                        });
                        
                        const shareData = {
                            gameId: currentGame.id,
                            gameName: currentGame.name,
                            method: 'native',
                            source: 'web',
                            platform: 'pc',
                            device: Analytics.getDeviceType(),
                            isGuest: Auth.isGuest || false,
                            userId: Auth.getCurrentUserId() || Auth.getGuestId() || 'anonymous'
                        };
                        
                        Analytics.track('game_share', shareData);
                        
                        if (Auth.isGuest) {
                            Analytics.track('guest_game_interaction', {
                                ...shareData,
                                interactionType: 'share'
                            });
                        }
                    } catch (error) {
                        // User cancelled share
                        if (error.name !== 'AbortError') {
                            Logger.error('Share failed:', error);
                        }
                    }
                } else {
                    // Fallback - copy to clipboard
                    try {
                        await navigator.clipboard.writeText(url);
                        alert('Link copied to clipboard!');
                        
                        const shareData = {
                            gameId: currentGame.id,
                            gameName: currentGame.name,
                            method: 'clipboard',
                            source: 'web',
                            platform: 'pc',
                            device: Analytics.getDeviceType(),
                            isGuest: Auth.isGuest || false,
                            userId: Auth.getCurrentUserId() || Auth.getGuestId() || 'anonymous'
                        };
                        
                        Analytics.track('game_share', shareData);
                        
                        if (Auth.isGuest) {
                            Analytics.track('guest_game_interaction', {
                                ...shareData,
                                interactionType: 'share'
                            });
                        }
                    } catch (error) {
                        Logger.error('Copy to clipboard failed:', error);
                        // Fallback fallback - select and copy
                        const textArea = document.createElement('textarea');
                        textArea.value = url;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            alert('Link copied to clipboard!');
                            
                            Analytics.track('game_share', {
                                gameId: currentGame.id,
                                gameName: currentGame.name,
                                method: 'fallback',
                                source: 'web',
                                platform: 'pc',
                                device: Analytics.getDeviceType()
                            });
                        } catch (err) {
                            alert('Failed to copy link');
                        }
                        document.body.removeChild(textArea);
                    }
                }
            });
            
            // Fullscreen button
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn && !fullscreenBtn.hasAttribute('data-listener-attached')) {
                console.log('‚úÖ Fullscreen button found, attaching listener');
                fullscreenBtn.setAttribute('data-listener-attached', 'true');
                fullscreenBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('‚õ∂ FULLSCREEN BUTTON CLICKED!');
                    
                    // Re-check currentGame from window
                    currentGame = window.currentGame;
                    
                    if (!currentGame) {
                        console.warn('‚ö†Ô∏è Game not loaded but allowing fullscreen anyway');
                    }
                    
                const iframe = document.getElementById('gameIframe');
                
                if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                    // Enter fullscreen
                    const requestFullscreen = iframe.requestFullscreen || 
                                            iframe.webkitRequestFullscreen || 
                                            iframe.mozRequestFullScreen || 
                                            iframe.msRequestFullscreen;
                    
                    if (requestFullscreen) {
                        requestFullscreen.call(iframe).then(() => {
                            const fullscreenData = {
                                gameId: currentGame.id,
                                gameName: currentGame.name,
                                source: 'web',
                                platform: 'pc',
                                device: Analytics.getDeviceType(),
                                isGuest: Auth.isGuest || false,
                                userId: Auth.getCurrentUserId() || Auth.getGuestId() || 'anonymous',
                                action: 'enter'
                            };
                            
                            Analytics.track('game_fullscreen_enter', fullscreenData);
                            
                            if (Auth.isGuest) {
                                Analytics.track('guest_game_interaction', {
                                    ...fullscreenData,
                                    interactionType: 'fullscreen'
                                });
                            }
                        }).catch(err => {
                            Logger.error('Failed to enter fullscreen:', err);
                            alert('Fullscreen not available');
                        });
                    }
                } else {
                    // Exit fullscreen
                    const exitFullscreen = document.exitFullscreen || 
                                         document.webkitExitFullscreen || 
                                         document.mozCancelFullScreen || 
                                         document.msExitFullscreen;
                    
                    if (exitFullscreen) {
                        exitFullscreen.call(document).then(() => {
                            Analytics.track('game_fullscreen_exit', {
                                gameId: currentGame.id,
                                gameName: currentGame.name,
                                source: 'web',
                                platform: 'pc',
                                device: Analytics.getDeviceType()
                            });
                        }).catch(err => {
                            Logger.error('Failed to exit fullscreen:', err);
                        });
                    }
                }
                });
            }
            
            console.log('‚úÖ All action buttons setup complete');
            
            // Setup rating stars
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', (e) => {
                    currentRating = parseInt(e.target.dataset.rating);
                    updateStarDisplay();
                });
            });
            
            document.getElementById('submitRating').addEventListener('click', submitRating);
        }
        
        function updateLikeButton() {
            const likeBtn = document.getElementById('likeBtn');
            if (isLiked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
            document.getElementById('likeCount').textContent = currentGame.likeCount || 0;
        }
        
        function updateStarDisplay() {
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < currentRating) {
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                }
            });
        }
        
        async function submitRating() {
            if (currentRating === 0) {
                alert('Please select a rating');
                return;
            }
            
            // Re-check currentGame from window
            currentGame = window.currentGame;
            
            if (!currentGame || !currentGame.id) {
                console.error('‚ùå Game not loaded for submitRating:', { currentGame, window: window.currentGame });
                alert('Game not loaded. Please refresh and try again.');
                return;
            }
            
            console.log('üìä Submitting rating:', { gameId: currentGame.id, rating: currentRating });
            
            // Allow guests to rate on web platform
            try {
                // Try to save rating to backend
                try {
                    await API.rateGame(currentGame.id, currentRating);
                } catch (apiError) {
                    Logger.warn('API rating failed, storing locally:', apiError);
                }
                
                // Store rating locally
                const localRatings = JSON.parse(localStorage.getItem('trioll_game_ratings') || '{}');
                localRatings[currentGame.id] = currentRating;
                localStorage.setItem('trioll_game_ratings', JSON.stringify(localRatings));
                
                closeRatingModal();
                
                // Track analytics for all users including guests
                const analyticsData = {
                    gameId: currentGame.id,
                    gameName: currentGame.name,
                    rating: currentRating,
                    source: 'web',
                    platform: 'pc',
                    device: Analytics.getDeviceType(),
                    isGuest: Auth.isGuest || false,
                    userId: Auth.getCurrentUserId() || Auth.getGuestId() || 'anonymous',
                    localStorage: true,
                    timestamp: Date.now()
                };
                
                Analytics.track('game_rate', analyticsData);
                
                // Track guest-specific event
                if (Auth.isGuest) {
                    Analytics.track('guest_game_interaction', {
                        ...analyticsData,
                        interactionType: 'rating'
                    });
                }
                
                alert('Thanks for rating!');
            } catch (error) {
                Logger.error('Failed to submit rating:', error);
                alert('Failed to submit rating. Please try again.');
            }
        }
        
        function showPurchaseModal() {
            document.getElementById('purchaseModal').classList.remove('hidden');
        }
        
        function closePurchaseModal() {
            document.getElementById('purchaseModal').classList.add('hidden');
        }
        
        function closeRatingModal() {
            document.getElementById('ratingModal').classList.add('hidden');
            currentRating = 0; // Reset rating
            updateStarDisplay();
        }
        
        // Make closeRatingModal available globally for onclick
        window.closeRatingModal = closeRatingModal;
        
        async function trackPurchaseIntent(intent) {
            closePurchaseModal();
            
            try {
                await API.trackPurchaseIntent(currentGame.id, intent);
                
                Analytics.track('purchase_intent', {
                    gameId: currentGame.id,
                    gameName: currentGame.name,
                    intent: intent,
                    source: 'web',
                    platform: 'pc',
                    device: Analytics.getDeviceType()
                });
                
                if (intent === 'yes' && currentGame.purchaseUrl) {
                    // Redirect to purchase with tracking
                    window.open(
                        `${currentGame.purchaseUrl}?ref=trioll&platform=pc`,
                        '_blank'
                    );
                } else if (intent !== 'askLater') {
                    // If they said no or yes without purchase URL, go back to games
                    setTimeout(() => {
                        window.location.href = 'games.html';
                    }, 500);
                } else {
                    // Ask later - just go back
                    window.location.href = 'games.html';
                }
            } catch (error) {
                Logger.error('Failed to track purchase intent:', error);
                // Still navigate back on error
                window.location.href = 'games.html';
            }
        }
        
        function handleBackToGames() {
            // Always show purchase intent popup when leaving a game (for testing)
            // You can add the timer back later by uncommenting the duration check
            
            // const gameStartTime = window.gameStartTime || Date.now();
            // const playDuration = (Date.now() - gameStartTime) / 1000; // in seconds
            
            // Show purchase intent if not already shown for this game
            if (currentGame && !window.purchaseIntentShown) {
                window.purchaseIntentShown = true; // Prevent showing multiple times
                
                // Update modal with game name
                document.getElementById('purchaseGameName').textContent = currentGame.name;
                
                // Show the purchase intent modal
                showPurchaseModal();
            } else {
                // Just go back if already shown or no game loaded
                window.location.href = 'games.html';
            }
        }
        
        function showError(message) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('compatError').classList.remove('hidden');
            document.getElementById('compatMessage').textContent = message;
        }
        
        // Comment Functions
        function setupCommentForm() {
            // Update form visibility based on auth state
            const form = document.getElementById('addCommentForm');
            const notice = form.querySelector('.comment-notice');
            const textarea = form.querySelector('textarea');
            const button = form.querySelector('button');
            
            if (Auth.isAuthenticated() || Auth.isGuest) {
                notice.style.display = 'none';
                textarea.disabled = false;
                button.disabled = false;
            } else {
                notice.style.display = 'block';
                textarea.disabled = true;
                button.disabled = true;
            }
            
            // Rating removed from comments - use Rate button instead
        }
        
        
        async function loadComments() {
            try {
                const response = await fetch(`${Config.API_BASE_URL}/games/${currentGame.id}/comments?page=${commentsPage}&limit=10`, {
                    headers: await API.getHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to load comments');
                
                const data = await response.json();
                const newComments = data.comments || [];
                hasMoreComments = data.hasMore || false;
                
                if (commentsPage === 1) {
                    comments = newComments;
                    displayComments();
                } else {
                    comments = [...comments, ...newComments];
                    appendComments(newComments);
                }
                
                // Show/hide load more button
                document.getElementById('loadMoreContainer').classList.toggle('hidden', !hasMoreComments);
                
                // Track web-specific comment view
                Analytics.track('comments_viewed', {
                    gameId: currentGame.id,
                    page: commentsPage,
                    count: newComments.length,
                    source: 'web',
                    platform: 'browser'
                });
            } catch (error) {
                Logger.error('Failed to load comments:', error);
                document.getElementById('commentsList').innerHTML = '<p class="error-message">Failed to load comments</p>';
            }
        }
        
        function displayComments() {
            const container = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                container.innerHTML = '<p class="no-comments">No comments yet. Be the first to share your thoughts!</p>';
                return;
            }
            
            container.innerHTML = '';
            comments.forEach(comment => {
                container.appendChild(createCommentElement(comment));
            });
        }
        
        function appendComments(newComments) {
            const container = document.getElementById('commentsList');
            newComments.forEach(comment => {
                container.appendChild(createCommentElement(comment));
            });
        }
        
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'comment-item';
            
            const ratingStars = comment.rating ? '‚≠ê'.repeat(comment.rating) : '';
            const timeAgo = getRelativeTime(new Date(comment.timestamp));
            const userName = comment.userName || 'Anonymous';
            const isOwner = comment.userId === Auth.getCurrentUserId();
            
            div.innerHTML = `
                <div class="comment-header">
                    <span class="comment-author">${userName}</span>
                    ${ratingStars ? `<span class="comment-rating">${ratingStars}</span>` : ''}
                    <span class="comment-time">${timeAgo}</span>
                </div>
                <p class="comment-text">${escapeHtml(comment.text)}</p>
                <div class="comment-actions">
                    <button class="comment-like-btn ${comment.userLiked ? 'liked' : ''}" onclick="likeComment('${comment.commentId}')">
                        üëç ${comment.likes || 0}
                    </button>
                    ${isOwner ? `
                        <button class="comment-edit-btn" onclick="editComment('${comment.commentId}')">Edit</button>
                        <button class="comment-delete-btn" onclick="deleteComment('${comment.commentId}')">Delete</button>
                    ` : ''}
                </div>
            `;
            
            return div;
        }
        
        async function postComment() {
            const text = document.getElementById('commentText').value.trim();
            
            if (!text) {
                alert('Please write a comment');
                return;
            }
            
            if (!Auth.isAuthenticated() && !Auth.isGuest) {
                alert('Please login to comment');
                return;
            }
            
            try {
                const commentData = {
                    text,
                    platform: 'pc' // Track as web comment
                };
                
                const response = await fetch(`${Config.API_BASE_URL}/games/${currentGame.id}/comments`, {
                    method: 'POST',
                    headers: await API.getHeaders(),
                    body: JSON.stringify(commentData)
                });
                
                if (!response.ok) throw new Error('Failed to post comment');
                
                // Clear form
                document.getElementById('commentText').value = '';
                
                // Reload comments
                commentsPage = 1;
                await loadComments();
                
                // Track web-specific comment post
                Analytics.track('comment_posted', {
                    gameId: currentGame.id,
                    hasRating: !!currentCommentRating,
                    rating: currentCommentRating,
                    source: 'web',
                    platform: 'browser'
                });
                
                alert('Comment posted successfully!');
            } catch (error) {
                Logger.error('Failed to post comment:', error);
                alert('Failed to post comment. Please try again.');
            }
        }
        
        async function loadMoreComments() {
            commentsPage++;
            await loadComments();
        }
        
        async function likeComment(commentId) {
            if (Auth.isGuest) {
                alert('Please login to like comments');
                return;
            }
            
            try {
                const response = await fetch(`${Config.API_BASE_URL}/comments/${commentId}/like`, {
                    method: 'PUT',
                    headers: await API.getHeaders()
                });
                
                if (response.ok) {
                    // Update local state
                    const comment = comments.find(c => c.commentId === commentId);
                    if (comment) {
                        comment.userLiked = !comment.userLiked;
                        comment.likes = (comment.likes || 0) + (comment.userLiked ? 1 : -1);
                    }
                    
                    // Refresh display
                    displayComments();
                    
                    // Track web-specific comment like
                    Analytics.track('comment_liked', {
                        commentId,
                        source: 'web',
                        platform: 'browser'
                    });
                }
            } catch (error) {
                Logger.error('Failed to like comment:', error);
            }
        }
        
        async function deleteComment(commentId) {
            if (!confirm('Delete this comment?')) return;
            
            try {
                const response = await fetch(`${Config.API_BASE_URL}/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: await API.getHeaders()
                });
                
                if (response.ok) {
                    comments = comments.filter(c => c.commentId !== commentId);
                    displayComments();
                    
                    // Track web-specific comment delete
                    Analytics.track('comment_deleted', {
                        commentId,
                        source: 'web',
                        platform: 'browser'
                    });
                }
            } catch (error) {
                Logger.error('Failed to delete comment:', error);
            }
        }
        
        function editComment(commentId) {
            // In a real app, would show edit form
            alert('Edit functionality coming soon!');
        }
        
        function getRelativeTime(date) {
            const seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + ' min ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + ' hours ago';
            const days = Math.floor(hours / 24);
            return days + ' days ago';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>